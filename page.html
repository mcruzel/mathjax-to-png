<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Générateur LaTeX vers PNG</title>
    <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        body {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            font-family: system-ui, sans-serif;
        }
        .controls {
            display: grid;
            gap: 1rem;
            margin: 1rem 0;
        }
        .mathjax-container {
            margin: 2rem 0;
            padding: 1rem;
            border: 1px solid #eee;
            color: #0B2948;
        }
        #png-output {
            max-width: 100%;
            height: auto;
            margin-top: 1rem;
        }
        .color-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
    </style>
</head>
<body>
    <h1>Générateur de formules LaTeX en PNG</h1>
    
    <div class="controls">
        <div>
            <label for="mathjax-input">Formule LaTeX :</label>
            <textarea id="mathjax-input" rows="4" style="width: 100%">\int x^2 dx</textarea>
        </div>

        <div class="color-controls">
            <label for="formula-color">Couleur de la sélection :</label>
            <input type="color" id="formula-color" value="#FF0000">
            <button onclick="applyColorToSelection()">Appliquer à la sélection</button>
        </div>

        <div class="color-controls">
            <label for="global-color">Couleur globale :</label>
            <input type="color" id="global-color" value="#0B2948">
            <button onclick="applyGlobalColor()">Appliquer à tout</button>
        </div>

        <div>
            <label for="font-size">Taille de police :</label>
            <select id="font-size">
                <option value="12pt">12 pt</option>
                <option value="16pt" selected>16 pt</option>
                <option value="24pt">24 pt</option>
                <option value="36pt">36 pt</option>
                <option value="48pt">48 pt</option>
            </select>
        </div>

        <button onclick="generatePNG()">Générer PNG</button>
    </div>

    <div id="mathjax-output" class="mathjax-container"></div>
    <img id="png-output" alt="Image de la formule générée" />

    <script>
        function applyColorToSelection() {
            const textarea = document.getElementById('mathjax-input');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const color = document.getElementById('formula-color').value;
            
            if (start !== end) {
                const colorCode = color.replace('#', '');
                const text = textarea.value;
                const selectedText = text.substring(start, end);
                const replacement = `\\textcolor{#${colorCode}}{${selectedText}}`;
                
                textarea.value = text.substring(0, start) + replacement + text.substring(end);
                
                const newCursorPos = start + replacement.length;
                textarea.selectionStart = textarea.selectionEnd = newCursorPos;
            }
        }

        function applyGlobalColor() {
            const outputDiv = document.getElementById("mathjax-output");
            const color = document.getElementById('global-color').value;
            outputDiv.style.color = color;
            generatePNG();
        }

        async function generatePNG() {
            const outputDiv = document.getElementById("mathjax-output");
            const mathjaxInput = document.getElementById("mathjax-input");
            const fontSize = document.getElementById("font-size").value;
            const globalColor = document.getElementById('global-color').value;

            let mathjaxCode = `\\(${mathjaxInput.value}\\)`;
            outputDiv.style.fontSize = fontSize;
            outputDiv.style.color = globalColor;
            outputDiv.innerHTML = mathjaxCode;

            try {
                await MathJax.typesetPromise([outputDiv]);
                const fontSizeInPt = parseFloat(fontSize);
                const scale = fontSizeInPt <= 36 ? 1.5 : 1.5 + (fontSizeInPt - 36) / 120;

                const canvas = await html2canvas(outputDiv, {
                    backgroundColor: null,
                    scale: scale,
                    useCORS: true,
                    logging: false
                });

                const img = document.getElementById('png-output');
                img.src = canvas.toDataURL('image/png');
                img.style.display = 'block';
            } catch (err) {
                console.error('Erreur:', err);
                alert('Erreur lors de la génération. Vérifiez la syntaxe LaTeX.');
            }
        }
    </script>
</body>
</html>
